# mabl テスト手順プロンプト作成ガイドライン

mablのテスト手順プロンプト（.md）を作成する際のルールとチェックリストです。
作成したプロンプトは mabl Test Creation Agent に渡してテストを生成します。

> **Note**: mabl-test固有のプロンプト作成の流れは [README.md](README.md) を参照してください。

---

## 1. テンプレート構造

すべてのプロンプトは以下のセクション構成に従ってください。

```markdown
# {テスト名}

## テスト概要
- **対象URL**: {app.url}/{番号ディレクトリ}/
- **テスト名**: {テスト名}
- **目的**: {1文で記述}
- **ラベル**: `ai-generated`, `{カテゴリ}`

## 画面構成
{目視で確認できるUI要素の説明}

## mabl固有の操作について（該当する場合のみ）
{iframe, タブ, ダウンロード等の注意事項}

## テスト手順
### 1. {セクション名}
1. {ステップ}
2. {ステップ}
...

## 期待される結果
- {箇条書き}

## 注意事項
- {mabl実行時の制約や既知の問題}
```

### セクション名の統一ルール

| セクション | 正しい名称 | 使わない名称 |
|-----------|-----------|-------------|
| 手順 | **テスト手順** | テストステップ |
| 結果 | **期待される結果** | 期待結果 |
| 補足 | **注意事項** | 備考 |
| mabl固有 | **mabl固有の操作について** | （任意の見出し） |

### テスト名の命名規則

- 形式: `mabl-test - {機能名}テスト`
- 例: `mabl-test - 画像表示・ダウンロードテスト`
- ファイル名: `{連番3桁}-{機能名(kebab-case)}.md`（例: `001-image-download.md`）

> **Note**: ファイル名の連番はテスト対象ページのディレクトリ番号に対応させてください。

---

## 2. ナビゲーション記述のルール

### app.url と対象ページURLの関係

mabl環境変数 `app.url` はトップページを指します。
テスト対象のサブページへのアクセス方法を**明確に**記述してください。

### 書き方

```
❌ 悪い例: 「ページにアクセスし」（どのページか不明）
❌ 悪い例: 「対象ページを開く」（ナビゲーション経路が不明）

✅ 良い例: 「{app.url}/001/ に直接アクセスする」
✅ 良い例: 「トップページのメニューから「001 - 画像表示・ダウンロード」リンクをクリックして /001/ ページに遷移する」
```

### 直接URL vs ナビゲーション経路

| 方法 | 使う場面 |
|------|---------|
| 直接URLアクセス | テスト対象が特定ページの機能に限定される場合（推奨） |
| メニューからの遷移 | トップページからのナビゲーション自体もテスト対象に含める場合 |

### このプロジェクトのURL構成

各テストページは番号付きディレクトリの `index.html` として配置されています。

| ディレクトリ | ページ内容 |
|------------|-----------|
| `/001/` | 画像表示・ダウンロード |
| `/002/` | テーブル表示 (5x5) |
| `/003/` | OTP入力フィールド |
| `/004/` | ファイルアップロード |
| `/005/` | Basic認証UI |
| `/006/` | 複数テキスト入力 |
| `/007/` | テキストエディタ・サンプル |
| `/008/` | PDF中の要素検出 |
| `/009/` | タブオーダーチェック |
| `/010/` | ブラウザタイムゾーンチェック |
| `/011/` | 日付・時刻入力 |

---

## 3. 要素の指定ルール

mablのTest Creation Agentは生成AIプロンプトで要素を探すため、**目視で要素を特定できる情報**のみを使用します。

### 使用する情報

| 情報 | 例 |
|------|-----|
| **表記テキスト** | 「ダウンロード」と表示されたボタン |
| **位置関係** | テーブルの3行目2列目のセル |
| **スタイル** | 枠線付きボタン、塗りつぶしボタン |
| **状態** | ボタンがクリックできない（無効化されている） |

### 使用しない情報

- id属性（例: `#download-button`）
- class属性（例: `.btn-primary`）
- data属性（例: `data-testid`）
- XPath

### 補足情報としてのdata-testid

Test Creation Agent向けプロンプトでは、目視情報を**主**とし、data-testidを**補足情報**として併記する方法も有効です。

```
✅ 良い例: 「ダウンロードボタン（data-testid="download-button"）をクリックする」
```

### 同一テキストの要素が複数ある場合

位置関係やセクション名で区別してください。

```
❌ 悪い例: 「"ダウンロード" ボタンをクリックする」（どちらのボタンか不明）

✅ 良い例: 「画像の下にある "ダウンロード" ボタンをクリックする」
✅ 良い例: 「1つ目の "ダウンロード" ボタンをクリックする」
```

---

## 4. テスト手順の構成パターン

テスト手順は以下の構成で記述してください。

```
1. ページ表示の確認
   └─ 対象ページが正しく表示されることを確認

2. 失敗ケースの確認（バリデーション等、該当する場合）
   └─ 不正な入力に対するエラー処理を先に検証

3. 成功ケースの実行
   └─ 正常な入力でメイン機能を実行

4. 成功結果の確認
   └─ 期待される結果が表示されることを確認

5. 後処理（状態のリセット、該当する場合）
   └─ 初期状態に戻す
```

### このプロジェクト固有の注意点

- 各ページは**静的HTML**であり、サーバーサイドのロジックはありません
- フォーム送信は `localStorage` やクライアントサイドJavaScriptで処理されるケースがあります
- ページ間の状態共有はありません（各ページは独立しています）

### 失敗ケースを先に実行する理由

- 成功ケースを先に実行すると、画面状態が変わり失敗ケースのテストが困難になる
- バリデーションロジックが正しく機能していることを確認してから成功フローに進む

### 後処理を含める理由

- テスト終了時の状態を一定にし、連続実行や繰り返し実行を可能にする
- 次のテスト実行時に前回の状態が影響しないようにする

---

## 5. mabl固有機能の記述ルール

以下の機能を使う場合、プロンプトに**明示的な操作指示**を記述してください。
曖昧な記述では Test Creation Agent が正しいステップを生成できません。

### ダウンロード検証（001: 画像ダウンロード、008: PDF検出）

GenAIアサートではダウンロード完了を視覚的に判定できません。
mablのダウンロード検証機能を明示的に指定してください。

```
✅ 良い例:
5. 「ダウンロード」ボタンをクリックする
6. mablのダウンロード検証機能を使用して、ファイルがダウンロードされたことを確認する

❌ 悪い例:
5. 「ダウンロード」ボタンをクリックする
6. 画像ファイルがダウンロードされることを確認する（← 何で確認するか不明）
```

### ファイルアップロード（004）

ファイルアップロードのテストでは、mablのファイルアップロード機能を使用します。

```
✅ 良い例:
3. mablのファイルアップロード機能を使用して、ファイル選択ダイアログでテストファイルを選択する
```

### アラート / ダイアログ

```
✅ 良い例:
5. ブラウザのアラートダイアログが表示される
6. アラートのテキストが「○○」であることを確認する
7. アラートのOKボタンをクリックして閉じる
```

### キーボード操作（003: OTP入力、009: タブオーダー）

キーボード操作が必要なテストでは、具体的なキー操作を明記してください。

```
✅ 良い例:
3. 1つ目の入力フィールドに「1」を入力する
4. 自動的に2つ目の入力フィールドにフォーカスが移動することを確認する
```

---

## 6. よくある失敗パターンと回避策

### 6.1 間違ったページに遷移する

- **原因**: `app.url` がトップページを指すため、サブページに到達できない
- **対策**: 対象ページへの直接URLアクセス（`{app.url}/{番号}/`）を指定する

### 6.2 ダウンロードの検証失敗

- **原因**: GenAIアサートでは視覚的にダウンロード完了を判定できない
- **対策**: mablのダウンロード検証機能（Download verification）の使用を明示指定する

### 6.3 localStorage依存の状態が残る

- **原因**: 前回のテスト実行で保存されたlocalStorageのデータが残っている
- **対策**: テスト開始時にlocalStorageのクリア手順を含めるか、テスト後に状態をリセットする

### 6.4 同名要素を特定できない

- **原因**: ページ内に同じテキストの要素が複数ある場合、どちらか特定できない
- **対策**: セクション名や位置関係で要素を明確に区別する

### 6.5 タイムゾーン依存のテストが環境によって失敗する

- **原因**: ブラウザのタイムゾーン設定がテスト実行環境によって異なる
- **対策**: プロンプトの注意事項にタイムゾーン依存である旨を記載し、相対的な検証にする

---

## 7. 生成AIアサーションの活用

mablの生成AIアサーション（GenAI Assert）を活用することで、動的なコンテンツに対しても意味的な検証が可能です。

### 適切な使用場面

```
✅ 適切: 「テーブルが5行5列で表示されていること」
✅ 適切: 「OTP入力フィールドが6つ表示されていること」
✅ 適切: 「ボタンが無効化されていることを確認する」
✅ 適切: 「タイムゾーン情報が表示されていること」
```

### 不適切な使用場面

```
❌ 不適切: 「ファイルがダウンロードされたことを確認する」（視覚的に判定不可）
❌ 不適切: 「localStorageにデータが保存されたことを確認する」（画面に表示されない情報）
```

### ポイント

- 画面上に**視覚的に表示されている情報**に対してのみ有効
- ダウンロード、ネットワークリクエスト、ストレージ等の非視覚情報には使用しない

---

## 8. プロンプト作成の実行手順

### Step 1: 対象ページの調査

1. 対象ディレクトリの `index.html` を読んで画面構成を把握する
2. JavaScriptファイルがあれば動的な振る舞いを確認する
3. 既存の類似プロンプト（`mabl-tests/prompts/`）を参照して構造を合わせる

### Step 2: プロンプト作成

1. 本ガイドラインのテンプレート構造（セクション1）に従う
2. 要素はすべて目視情報で記述する（セクション3）
3. テスト手順は構成パターンに従う（セクション4）
4. mabl固有機能が必要な場合は明示的に記述する（セクション5）

### Step 3: 品質チェック

作成後、以下のチェックリストで確認してください。

---

## 9. 品質チェックリスト

### テンプレート

- [ ] テンプレート構造（セクション1）に準拠しているか
- [ ] セクション名が統一ルールに従っているか（「テスト手順」「期待される結果」「注意事項」）
- [ ] テスト概要に対象URL、テスト名、目的、ラベルがすべて含まれているか

### ナビゲーション

- [ ] 対象ページへのアクセス方法が明確か（直接URL or メニュー経路）
- [ ] 「ページにアクセスし」のような曖昧な記述がないか

### 要素指定

- [ ] すべての要素が目視情報（テキスト、位置、スタイル、状態）で記述されているか
- [ ] id/class/data属性を主たる指定方法にしていないか
- [ ] 同一テキストの要素が位置関係で区別されているか

### テスト手順

- [ ] 各ステップが具体的で曖昧さがないか
- [ ] 該当する場合、失敗ケース → 成功ケースの順になっているか
- [ ] 該当する場合、後処理（状態リセット）が含まれているか

### mabl固有機能

- [ ] ダウンロード検証がある場合、mablのダウンロード検証機能の使用を明記しているか
- [ ] ファイルアップロードがある場合、mablのアップロード機能の使用を明記しているか
- [ ] アラート/ダイアログがある場合、テキスト確認と閉じ操作が明記されているか
- [ ] 生成AIアサーションの使用が適切か（視覚情報のみに使用しているか）

### 命名

- [ ] テスト名が `mabl-test - {機能名}テスト` 形式か
- [ ] ファイル名が `{連番3桁}-{機能名}.md` 形式か

---

## 10. ラベル体系

### 作成方法ラベル（必須）

- `ai-generated`: Test Creation Agentで作成したテスト

### 機能カテゴリラベル

| ラベル | 対象ページ |
|--------|----------|
| `image` | 001 - 画像表示・ダウンロード |
| `table` | 002 - テーブル表示 |
| `form` | 003 - OTP入力, 004 - ファイルアップロード, 006 - 複数テキスト入力, 011 - 日付・時刻入力 |
| `auth` | 005 - Basic認証UI |
| `editor` | 007 - テキストエディタ |
| `pdf` | 008 - PDF中の要素検出 |
| `accessibility` | 009 - タブオーダーチェック |
| `browser` | 010 - ブラウザタイムゾーンチェック |

---

## 更新履歴

| 日付 | 内容 |
|------|------|
| 2026-02-17 | 初版作成。mabl-sandboxのガイドラインを参考に、静的HTMLテストサイト向けに調整 |
